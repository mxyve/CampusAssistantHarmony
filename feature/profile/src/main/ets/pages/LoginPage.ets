import { RouterModule, RouterMap } from 'basic';
import { AuthApi } from '../api/AuthApi';
import { UserApi } from '../api/UserApi'; // å¯¼å…¥UserApi
import { storageUtil } from 'storage';
import promptAction from '@ohos.promptAction';
import { TokenVO, LoginDTO, SmsDTO } from '../types/AuthType';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { Logger } from '@hmos/logger-kit';

@Builder
export function LoginPageBuilder() {
  LoginPage()
}

@Entry
@Component
export struct LoginPage {
  // åŸºç¡€çŠ¶æ€
  @State username: string = '';
  @State password: string = '';
  @State loading: boolean = false;
  @State showPassword: boolean = false;
  // çŸ­ä¿¡ç™»å½•ç›¸å…³çŠ¶æ€
  @State loginType: 'password' | 'sms' = 'password';
  @State mobile: string = '';
  @State smsCode: string = '';
  @State countdown: number = 0;
  @State canSendSms: boolean = true;
  private timer: number = -1;

  build() {
    NavDestination() {
      Column() {
        // é¡¶éƒ¨å®‰å…¨åŒºåŸŸ
        Blank()
          .height(56)
          .backgroundColor('#FFFFFF')

        // ä¸»å†…å®¹åŒºåŸŸ
        Scroll() {
          Column({ space: 24 }) {
            // æ ‡é¢˜åŒºåŸŸ
            this.buildHeader()

            // ç™»å½•æ–¹å¼åˆ‡æ¢æ 
            this.buildLoginTypeSwitch()

            // è¡¨å•åŒºåŸŸï¼ˆæ ¹æ®ç™»å½•ç±»å‹åˆ‡æ¢ï¼‰
            if (this.loginType === 'password') {
              this.buildPasswordForm()
            } else {
              this.buildSmsForm()
            }

            // ç™»å½•æŒ‰é’®
            this.buildLoginButton()
          }
          .padding({
            top: 40,
            left: 24,
            right: 24,
            bottom: 24
          })
        }
        .scrollBar(BarState.Off)
        .layoutWeight(1)

        // åº•éƒ¨å®‰å…¨åŒºåŸŸ
        Blank()
          .height(48)
          .backgroundColor('#FFFFFF')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#FFFFFF')
    }
  }

  // ============ UIæ„å»ºæ–¹æ³• ============

  @Builder
  buildHeader() {
    Column({ space: 16 }) {
      Text('æ™ºæ…§æ ¡å›­åŠ©æ‰‹')
        .fontSize(32)
        .fontWeight(FontWeight.Bold)
        .fontColor('#000000')
        .textAlign(TextAlign.Center)

      Text(this.loginType === 'password' ? 'æ¬¢è¿å›æ¥ï¼Œè¯·ç™»å½•æ‚¨çš„è´¦å·' : 'çŸ­ä¿¡å¿«æ·ç™»å½•')
        .fontSize(16)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .margin({ bottom: 20 })
  }

  @Builder
  buildLoginTypeSwitch() {
    Row({ space: 12 }) {
      Button('è´¦å·å¯†ç ç™»å½•', { type: ButtonType.Normal })
        .width('50%')
        .height(48)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .borderRadius(8)
        .backgroundColor(this.loginType === 'password' ? '#1890FF' : '#F5F5F5')
        .fontColor(this.loginType === 'password' ? '#FFFFFF' : '#333333')
        .enabled(!this.loading)
        .onClick(() => {
          this.loginType = 'password';
          this.countdown = 0;
          this.canSendSms = true;
          if (this.timer !== -1) {
            clearInterval(this.timer);
            this.timer = -1;
          }
        })

      Button('çŸ­ä¿¡éªŒè¯ç ç™»å½•', { type: ButtonType.Normal })
        .width('50%')
        .height(48)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .borderRadius(8)
        .backgroundColor(this.loginType === 'sms' ? '#1890FF' : '#F5F5F5')
        .fontColor(this.loginType === 'sms' ? '#FFFFFF' : '#333333')
        .enabled(!this.loading)
        .onClick(() => {
          this.loginType = 'sms';
          this.showPassword = false;
        })
    }
    .width('100%')
    .margin({ bottom: 20 })
  }

  @Builder
  buildPasswordForm() {
    Column({ space: 20 }) {
      Column({ space: 8 }) {
        Text('ç”¨æˆ·å')
          .fontSize(14)
          .fontColor('#333333')
          .width('100%')
          .textAlign(TextAlign.Start)

        TextInput({ placeholder: 'è¯·è¾“å…¥å­¦å·/å·¥å·', text: this.username })
          .width('100%')
          .height(56)
          .fontSize(16)
          .borderRadius(12)
          .backgroundColor('#F5F5F5')
          .padding({ left: 16, right: 16 })
          .onChange((value: string) => {
            this.username = value;
          })
      }

      Column({ space: 8 }) {
        Row() {
          Text('å¯†ç ')
            .fontSize(14)
            .fontColor('#333333')
            .layoutWeight(1)
        }
        .width('100%')

        Row() {
          TextInput({
            placeholder: 'è¯·è¾“å…¥å¯†ç ',
            text: this.password
          })
            .width('100%')
            .height(56)
            .fontSize(16)
            .type(this.showPassword ? InputType.Normal : InputType.Password)
            .backgroundColor('#F5F5F5')
            .borderRadius(12)
            .padding({ left: 16, right: 16 })
            .layoutWeight(1)
            .onChange((value: string) => {
              this.password = value;
            })
        }
        .alignItems(VerticalAlign.Center)
      }
    }
  }

  @Builder
  buildSmsForm() {
    Column({ space: 20 }) {
      Column({ space: 8 }) {
        Text('æ‰‹æœºå·')
          .fontSize(14)
          .fontColor('#333333')
          .width('100%')
          .textAlign(TextAlign.Start)

        TextInput({ placeholder: 'è¯·è¾“å…¥æ‰‹æœºå·', text: this.mobile })
          .width('100%')
          .height(56)
          .fontSize(16)
          .borderRadius(12)
          .backgroundColor('#F5F5F5')
          .padding({ left: 16, right: 16 })
          .type(InputType.PhoneNumber)
          .maxLength(11)
          .onChange((value: string) => {
            this.mobile = value;
          })
      }

      Column({ space: 8 }) {
        Text('éªŒè¯ç ')
          .fontSize(14)
          .fontColor('#333333')
          .width('100%')
          .textAlign(TextAlign.Start)

        Row() {
          TextInput({ placeholder: 'è¯·è¾“å…¥6ä½éªŒè¯ç ', text: this.smsCode })
            .width('100%')
            .height(56)
            .fontSize(16)
            .borderRadius(12)
            .backgroundColor('#F5F5F5')
            .padding({ left: 16, right: 16 })
            .layoutWeight(1)
            .type(InputType.Number)
            .maxLength(6)
            .onChange((value: string) => {
              this.smsCode = value;
            })

          Button(this.countdown > 0 ? `${this.countdown}ç§’åé‡è¯•` : 'è·å–éªŒè¯ç ')
            .width(120)
            .height(56)
            .fontSize(14)
            .borderRadius(12)
            .backgroundColor('#1890FF')
            .fontColor('#FFFFFF')
            .margin({ left: 12 })
            .enabled(this.canSendSms && this.mobile.length === 11 && !this.loading)
            .onClick(() => {
              this.sendSmsCode();
            })
        }
        .alignItems(VerticalAlign.Center)
      }
    }
  }

  @Builder
  buildLoginButton() {
    Column({ space: 16 }) {
      Button('ç™»å½•', { type: ButtonType.Normal })
        .width('100%')
        .height(56)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .borderRadius(12)
        .backgroundColor('#1890FF')
        .fontColor('#FFFFFF')
        .enabled(!this.loading && this.getLoginButtonEnabledStatus())
        .onClick(() => {
          this.doLogin();
        })

      if (this.loading) {
        LoadingProgress()
          .color('#1890FF')
          .width(32)
          .height(32)
      }
    }
    .width('100%')
    .margin({ top: 20 })
  }

  // ============ ä¸šåŠ¡é€»è¾‘æ–¹æ³• ============

  private getLoginButtonEnabledStatus(): boolean {
    if (this.loginType === 'password') {
      return !!this.username.trim() && !!this.password.trim();
    } else {
      return !!this.mobile.trim() && !!this.smsCode.trim() && this.mobile.length === 11;
    }
  }

  // ä¿®æ”¹doLoginæ–¹æ³•ï¼Œæ·»åŠ ç”¨æˆ·ä¿¡æ¯è·å–
  private async doLogin(): Promise<void> {
    if (this.loginType === 'password') {
      if (!this.username.trim() || !this.password.trim()) {
        this.showToast('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return;
      }
    } else {
      if (!this.mobile.trim() || !this.smsCode.trim()) {
        this.showToast('è¯·è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç ');
        return;
      }
      const mobileReg = /^1[3-9]\d{9}$/;
      if (!mobileReg.test(this.mobile.trim())) {
        this.showToast('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·');
        return;
      }
    }

    this.loading = true;

    try {
      let response: TokenVO | null = null;
      if (this.loginType === 'password') {
        const loginData: LoginDTO = {
          username: this.username.trim(),
          password: this.password.trim()
        };
        response = await AuthApi.passwordLogin(loginData) as TokenVO | null;
      } else {
        const smsData: SmsDTO = {
          mobile: this.mobile.trim(),
          code: this.smsCode.trim()
        };
        response = await AuthApi.smsLogin(smsData) as TokenVO | null;
        console.info('â­responseï¼š', response)
      }

      if (response?.token) {
        // ä¿å­˜token
        await storageUtil.set('token', response.token);
        console.info('âœ… token å®é™…å­˜å‚¨å€¼ï¼š', await storageUtil.get('token'));
        console.info('âœ… token å·²å†™å…¥ï¼š', response.token)

        // è·å–ç”¨æˆ·ä¿¡æ¯
        const userInfo = await UserApi.getUserInfo();
        if (userInfo) {
          await storageUtil.setObject('userInfo', userInfo);
          console.log('ğŸˆ userInfo å·²å†™å…¥ï¼š', userInfo)
          AppStorage.setOrCreate('currentUserInfo', userInfo);
        }

        // æ›´æ–°å…¨å±€ç™»å½•çŠ¶æ€
        AppStorage.setOrCreate('isLoggedIn', true);

        hilog.info(0x0000, 'LoginPage', `ç™»å½•æˆåŠŸï¼Œç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(userInfo)}`);
        this.showToast('ç™»å½•æˆåŠŸ');

        // å»¶è¿Ÿè·³è½¬ï¼Œç¡®ä¿çŠ¶æ€å·²æ›´æ–°
        setTimeout(() => {
          this.loading = false;
          this.navigateAfterLogin();
        }, 500);
      } else {
        this.loading = false;
        this.showToast(this.loginType === 'password'
          ? 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç '
          : 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥éªŒè¯ç æ˜¯å¦æ­£ç¡®');
      }
    } catch (error) {
      this.loading = false;
      hilog.error(0x0000, 'LoginPage', `ç™»å½•å¼‚å¸¸: ${JSON.stringify(error)}`);

      let errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
      if (error?.response?.data?.message) {
        errorMessage = error.response.data.message;
      } else if (error?.message) {
        errorMessage = error.message;
      }
      this.showToast(errorMessage);
    }
  }

  // å‘é€çŸ­ä¿¡éªŒè¯ç 
  private async sendSmsCode(): Promise<void> {
    const mobileReg = /^1[3-9]\d{9}$/;
    if (!mobileReg.test(this.mobile.trim())) {
      this.showToast('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·');
      return;
    }

    this.loading = true;
    try {
      const result = await AuthApi.sendSmsCode(this.mobile.trim());
      if (result !== null) {
        this.showToast(result ? `éªŒè¯ç å‘é€æˆåŠŸ: ${result}` : 'éªŒè¯ç å‘é€æˆåŠŸ');
        this.startCountdown();
      } else {
        this.showToast('éªŒè¯ç å‘é€å¤±è´¥');
      }
    } catch (error) {
      hilog.error(0x0000, 'LoginPage', `å‘é€éªŒè¯ç å¼‚å¸¸: ${JSON.stringify(error)}`);
      this.showToast('éªŒè¯ç å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      this.loading = false;
    }
  }

  private startCountdown(): void {
    this.countdown = 60;
    this.canSendSms = false;

    if (this.timer !== -1) {
      clearInterval(this.timer);
    }

    this.timer = setInterval(() => {
      if (this.countdown > 0) {
        this.countdown--;
      } else {
        this.canSendSms = true;
        clearInterval(this.timer);
        this.timer = -1;
      }
    }, 1000);
  }

  aboutToDisappear(): void {
    if (this.timer !== -1) {
      clearInterval(this.timer);
      this.timer = -1;
    }
  }

  // ç™»å½•æˆåŠŸåå¯¼èˆª - æ·»åŠ è¿”å›ä¹‹å‰çš„é¡µé¢é€»è¾‘
  private navigateAfterLogin(): void {
    // è·å–ç™»å½•å‰çš„é¡µé¢ç´¢å¼•
    const beforeLoginPageIndex = AppStorage.get<number>('beforeLoginPageIndex') || 0;
    hilog.info(0x0000, 'LoginPage', `ç™»å½•å‰é¡µé¢ç´¢å¼•: ${beforeLoginPageIndex}`);

    RouterModule.replace(RouterMap.HOME_PAGE);
    if (beforeLoginPageIndex > 0) {
      // è®¾ç½®å½“å‰ Tab ç´¢å¼•
      AppStorage.setOrCreate('currentTabIndex', beforeLoginPageIndex);
      // æ¸…é™¤ä¿å­˜çš„ç´¢å¼•
      AppStorage.setOrCreate('beforeLoginPageIndex', 0);
      hilog.info(0x0000, 'LoginPage', 'è¿”å›ä¹‹å‰çš„ Tab é¡µé¢');
      RouterModule.pop(); // è¿”å›ä¸Šä¸€é¡µï¼ˆç™»å½•é¡µï¼‰
    } else {
      hilog.info(0x0000, 'LoginPage', 'è·³è½¬åˆ°é¦–é¡µ');
      RouterModule.replace(RouterMap.HOME_PAGE);
    }
  }

  private showToast(message: string): void {
    promptAction.showToast({
      message: message,
      duration: 2000
    });
  }
}