import promptAction from '@ohos.promptAction';
import { UserApi } from '../api/UserApi';
import photoAccessHelper from '@ohos.file.photoAccessHelper';
import fs from '@ohos.file.fs';
import common from '@ohos.app.ability.common';
import { PictureApi } from '../api/PictureApi';
import util from '@ohos.util';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
import { storageUtil } from 'storage';

// æ˜¾å¼å®šä¹‰æ‰€æœ‰å¿…è¦æ¥å£ï¼ˆè§£å†³ç±»å‹æŠ¥é”™ï¼‰
interface PhotoSelectOptions {
  MIMEType: photoAccessHelper.PhotoViewMIMETypes; // é€‚é…æ–°APIç±»å‹
  maxSelectNumber: number;
}

interface FileInfo {
  path: string;
  name: string;
  size: number;
  type: string;
}

interface UpdateProfileDTO {
  nickname?: string;
  email?: string;
  gender?: number;
  avatar?: string;
}

interface GenderOption {
  label: string;
  value: string;
}

interface OpenModeInterface {
  READ_ONLY: number;
  WRITE_ONLY: number;
  READ_WRITE: number;
  CREATE: number;
}


const OpenMode: OpenModeInterface = {
  READ_ONLY: 0o000000, // å¯¹åº”fs.OpenMode.READ_ONLY
  WRITE_ONLY: 0o000001,
  READ_WRITE: 0o000002,
  CREATE: 0o000100
};

// æ— ä»»ä½•typeof/unknown/ç´¢å¼•ç±»å‹çš„å·¥å…·å‡½æ•°ï¼ˆå®Œå…¨ç¬¦åˆArkTSè§„èŒƒï¼‰
function getFileFd(path: string, mode: number): number {
  // ç›´æ¥è°ƒç”¨ï¼Œæ— ç±»å‹æ–­è¨€ï¼ˆç»•å¼€unknown/anyï¼‰
  const fd = fs.openSync(path, mode);
  // è¿è¡Œæ—¶æ ¡éªŒï¼ˆç¡®ä¿æ˜¯æ•°å­—ï¼Œæ— ç±»å‹æ–­è¨€ï¼‰
  if (typeof fd !== 'number' || isNaN(fd)) {
    throw new Error('æ–‡ä»¶å¥æŸ„å¿…é¡»ä¸ºæœ‰æ•ˆæ•°å­—');
  }
  return fd;
}

@Builder
export function EditProfilePageBuilder() {
  EditProfilePage()
}

@Component
export struct EditProfilePage {
  @State nickname: string = '';
  @State email: string = '';
  @State gender: string = '0';
  @State avatarUrl: string = 'app.media.ic_default_avatar';
  @State loading: boolean = true;
  @State isSaving: boolean = false;
  @State private imageBuffer: ArrayBuffer | null = null;
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;
  private originalAvatarUrl: string = '';
  private selectedImageUri: string | null = null;

  aboutToAppear() {
    this.loadUserInfo();
  }

  private async loadUserInfo() {
    try {
      this.loading = true;
      const userInfo = await UserApi.getUserInfo();
      if (userInfo) {
        this.nickname = userInfo.nickname || '';
        this.email = userInfo.email || '';
        this.gender = userInfo.gender?.toString() || '0';
        this.avatarUrl = userInfo.avatar || 'app.media.ic_default_avatar';
        this.originalAvatarUrl = this.avatarUrl;
      } else {
        promptAction.showToast({ message: 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥' });
        this.originalAvatarUrl = 'app.media.ic_default_avatar';
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸:', error);
      promptAction.showToast({ message: 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸' });
      this.originalAvatarUrl = 'app.media.ic_default_avatar';
    } finally {
      this.loading = false;
    }
  }

  // ========== æ ¸å¿ƒé‡æ„ï¼šå®Œå…¨å¯¹é½åä¸ºæ–‡æ¡£æ–¹æ¡ˆ ==========
  private async selectAvatar() {
    try {
      // 1. æç®€æƒé™ç”³è¯·ï¼ˆæ— tokenIdï¼Œæ— BundleInfoæŠ¥é”™ï¼‰
      const context = this.context;
      const permission = 'ohos.permission.READ_IMAGEVIDEO';
      try {
        const atManager = abilityAccessCtrl.createAtManager();
        const result = await atManager.requestPermissionsFromUser(context, [permission]);
        if (result.authResults[0] !== abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED) {
          promptAction.showToast({ message: 'éœ€è¦æˆäºˆç›¸å†Œæƒé™æ‰èƒ½é€‰æ‹©å›¾ç‰‡' });
          return;
        }
      } catch (err) {
        console.error('æƒé™ç”³è¯·å¤±è´¥:', err);
        promptAction.showToast({ message: 'æƒé™ç”³è¯·å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¼€å¯ç›¸å†Œæƒé™' });
        return;
      }

      // 2. API12+ é€‰æ‹©å›¾ç‰‡ï¼ˆæ˜¾å¼ç±»å‹ï¼Œæ— æ— ç±»å‹å­—é¢é‡æŠ¥é”™ï¼‰
      const photoPicker = new photoAccessHelper.PhotoViewPicker();
      const selectOptions: PhotoSelectOptions = {
        MIMEType: photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      };
      const pickResult = await photoPicker.select(selectOptions);
      if (!pickResult || !pickResult.photoUris || pickResult.photoUris.length === 0) {
        promptAction.showToast({ message: 'æœªé€‰æ‹©å›¾ç‰‡' });
        return;
      }

      // 3. åä¸ºæ–‡æ¡£å…œåº•æ–¹æ¡ˆï¼šç›´æ¥é€šè¿‡URIæ‰“å¼€å›¾ç‰‡ï¼ˆç»•å¼€æ‰€æœ‰Predicates/FetchOptionsæŠ¥é”™ï¼‰
      const imageUri = pickResult.photoUris[0];
      this.selectedImageUri = imageUri;

      // æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥æ‰“å¼€URIå¯¹åº”çš„æ–‡ä»¶ï¼ˆæ— éœ€getAssets/æ¡ä»¶æŸ¥è¯¢ï¼‰
      let file: fs.File;
      try {
        // é¸¿è’™API12+ ç›´æ¥é€šè¿‡URIæ‰“å¼€åª’ä½“æ–‡ä»¶ï¼ˆåä¸ºæ–‡æ¡£æ¨èï¼‰
        file = await fs.open(imageUri, fs.OpenMode.READ_ONLY);
      } catch (openErr) {
        console.error('ç›´æ¥æ‰“å¼€å›¾ç‰‡å¤±è´¥:', openErr);
        promptAction.showToast({ message: 'å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·æ¢ä¸€å¼ ' });
        return;
      }

      // 4. è¯»å–æ–‡ä»¶å­—èŠ‚ï¼ˆæ— fileFdç±»å‹æŠ¥é”™ï¼‰
      const fileStat = await fs.stat(file.fd);
      const maxSize = 5 * 1024 * 1024; // 5MBé™åˆ¶
      if (fileStat.size <= 0 || fileStat.size > maxSize) {
        await fs.close(file);
        promptAction.showToast({ message: 'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB' });
        return;
      }

      // è¯»å–å­—èŠ‚ï¼ˆæ˜¾å¼ç±»å‹ï¼Œæ— any/unknownï¼‰
      const buffer: ArrayBuffer = new ArrayBuffer(fileStat.size);
      await fs.lseek(file.fd, 0, 0); // 0 = SEEK_SET
      let readLen = 0;
      while (readLen < fileStat.size) {
        const once = await fs.read(file.fd, buffer, { offset: readLen, length: fileStat.size - readLen });
        readLen += once;
      }
      console.log('ğŸ”¥ è¯»åˆ°å­—èŠ‚æ•°:', buffer.byteLength);
      console.log('ğŸ” closeå‰fileå¯¹è±¡:', {
        fd: file.fd,
        isValid: file.fd > 0,
        fileType: typeof file
      });
      try {
        await fs.close(file); // å•ç‹¬try-catchï¼Œç¡®è®¤æ˜¯å¦æ˜¯closeè§¦å‘æŠ¥é”™
        console.log('âœ… fs.close æ‰§è¡ŒæˆåŠŸ');
      } catch (closeErr) {
        console.error('âŒ fs.close å¤±è´¥:', closeErr.message, closeErr.stack);
      }

      console.log('ğŸ” å‡†å¤‡èµ‹å€¼imageBuffer:', {
        bufferValid: buffer.byteLength > 0,
        imageBufferCurrent: this.imageBuffer // ç¡®è®¤å½“å‰çŠ¶æ€å€¼
      });

      try {
        this.imageBuffer = buffer; // å•ç‹¬try-catch
        console.log('âœ… imageBuffer èµ‹å€¼æˆåŠŸ');
      } catch (assignErr) {
        console.error('âŒ imageBuffer èµ‹å€¼å¤±è´¥:', assignErr.message, assignErr.stack);
      }
      this.avatarUrl = imageUri;
      promptAction.showToast({ message: 'å›¾ç‰‡å·²é€‰æ‹©ï¼Œç‚¹å‡»ä¿å­˜ç”Ÿæ•ˆ' });

    } catch (err) {
      console.error('é€‰å›¾/è¯»å–å¤±è´¥:', err);
      promptAction.showToast({ message: 'å›¾ç‰‡é€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  // ä¿®å¤saveProfileçš„finalAvatarç±»å‹æŠ¥é”™
  private async saveProfile() {
    if (this.isSaving) {
      return;
    }
    if (!this.nickname.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æ˜µç§°' });
      return;
    }

    this.isSaving = true;
    try {
      let finalAvatar = this.originalAvatarUrl;
      // æ ¸å¿ƒä¿®æ”¹1ï¼šéç©ºæ–­è¨€ + ç±»å‹æ ¡éªŒï¼Œç¡®ä¿ä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²
      if (this.selectedImageUri) {
        promptAction.showToast({ message: 'æ­£åœ¨ä¸Šä¼ å¤´åƒâ€¦' });
        // æ ¸å¿ƒä¿®æ”¹2ï¼š! éç©ºæ–­è¨€ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨selectedImageUriä¸€å®šæ˜¯å­—ç¬¦ä¸²ï¼ˆå·²é€šè¿‡ifæ ¡éªŒï¼‰
        const uploadResult = await PictureApi.uploadAvatar(this.selectedImageUri!);
        if (!uploadResult) {
          promptAction.showToast({ message: 'å¤´åƒä¸Šä¼ å¤±è´¥' });
          this.isSaving = false;
          return;
        }
        finalAvatar = uploadResult;
        this.imageBuffer = null; // æ¸…ç©ºå†—ä½™äºŒè¿›åˆ¶ç¼“å­˜
      }

      const updateData: UpdateProfileDTO = {
        nickname: this.nickname.trim(),
        email: this.email.trim() || undefined,
        gender: parseInt(this.gender) || 0,
        avatar: finalAvatar
      };

      const updateResult = await UserApi.updateProfile(updateData);
      if (updateResult) {
        promptAction.showToast({ message: 'ä¿å­˜æˆåŠŸ' });
        this.originalAvatarUrl = finalAvatar;
        this.imageBuffer = null;
        const latestUser = await UserApi.getUserInfo();
        AppStorage.setOrCreate('currentUserInfo', latestUser); // å…¨å±€çŠ¶æ€
        await storageUtil.setObject('userInfo', latestUser); // æœ¬åœ°ç¼“å­˜
        if (latestUser) {
          this.avatarUrl = latestUser.avatar || this.avatarUrl;
        }
      } else {
        promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•' });
      }

    } catch (saveErr) {
      console.error('ä¿å­˜å¤±è´¥:', saveErr);
      promptAction.showToast({ message: 'ç½‘ç»œå¼‚å¸¸/ä¿å­˜å¤±è´¥' });
    } finally {
      this.isSaving = false;
    }
  }

  build() {
    NavDestination() {
      Column() {
        // ä¿å­˜æŒ‰é’®ï¼ˆæ–‡æ¡£æ¨èçš„ç¦ç”¨æ€å¤„ç†ï¼‰
        Row() {
          Text(this.isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜')
            .fontSize(16)
            .fontColor(this.isSaving ? '#999999' : '#1890FF')
            .onClick(() => !this.isSaving && this.saveProfile())
        }
        .padding(16)
        .backgroundColor('#FFFFFF')
        .width('100%')

        // åŠ è½½çŠ¶æ€
        if (this.loading) {
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor('#999999')
          }
        } else {
          Scroll() {
            Column({ space: 20 }) {

              // å¤´åƒåŒºåŸŸï¼ˆæ–‡æ¡£æ¨èçš„UIå¸ƒå±€ï¼‰
              Column({ space: 12 }) {
                Text('å¤´åƒ').fontSize(16).textAlign(TextAlign.Start)
                Row({ space: 16 }) {
                  Image(this.avatarUrl.startsWith('app.media') ? $r(this.avatarUrl) : this.avatarUrl)
                    .width(80)
                    .height(80)
                    .borderRadius(40)
                    .objectFit(ImageFit.Cover)
                  Button('é€‰æ‹©å¤´åƒ')
                    .width(120)
                    .height(40)
                    .borderRadius(8)
                    .backgroundColor('#F5F5F5')
                    .onClick(() => this.selectAvatar())
                }
              }

              // æ˜µç§°
              Column({ space: 8 }) {
                Text('æ˜µç§°').fontSize(16).textAlign(TextAlign.Start)
                TextInput({ placeholder: 'è¯·è¾“å…¥æ˜µç§°', text: this.nickname })
                  .width('100%')
                  .height(56)
                  .backgroundColor('#F5F5F5')
                  .borderRadius(12)
                  .padding(16)
                  .onChange((v) => this.nickname = v)
              }

              // é‚®ç®±
              Column({ space: 8 }) {
                Text('é‚®ç®±').fontSize(16).textAlign(TextAlign.Start)
                TextInput({ placeholder: 'è¯·è¾“å…¥é‚®ç®±', text: this.email })
                  .width('100%')
                  .height(56)
                  .backgroundColor('#F5F5F5')
                  .borderRadius(12)
                  .padding(16)
                  .onChange((v) => this.email = v)
              }

              // æ€§åˆ«é€‰æ‹©ï¼ˆæ–‡æ¡£æ¨èçš„ForEachå†™æ³•ï¼‰
              Column({ space: 8 }) {
                Text('æ€§åˆ«').fontSize(16).textAlign(TextAlign.Start)
                Row({ space: 20 }) {
                  ForEach(
                    [
                      { label: 'ç”·', value: '1' },
                      { label: 'å¥³', value: '2' },
                      { label: 'ä¿å¯†', value: '0' }
                    ],
                    (item: GenderOption) => {
                      Row() {
                        Radio({ value: item.value, group: 'gender' })
                          .checked(this.gender === item.value)
                          .onChange((c: boolean) => c && (this.gender = item.value))
                        Text(item.label).fontSize(14)
                      }
                    },
                    (item: GenderOption) => item.value
                  )
                }
              }
            }
          }
          .scrollBar(BarState.Off)
          .layoutWeight(1)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
    }
    .title('ç¼–è¾‘èµ„æ–™')
  }
}