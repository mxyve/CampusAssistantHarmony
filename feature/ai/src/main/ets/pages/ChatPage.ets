import { RouterModule, RouterMap } from 'basic';
import { StreamChatComponent, MessageItem } from '../components/StreamChatComponent';
import promptAction from '@ohos.promptAction';

interface UserInfo {
  id?: number;
  username?: string;
  nickname?: string;
  avatar?: string;
}

@Builder
export function ChatPageBuilder() {
  ChatPage()
}

@Component
export struct ChatPage {
  @State sessionId: number = 0;
  @State initialMessages: MessageItem[] = []; // æ–°å»ºä¼šè¯æ— å†å²æ¶ˆæ¯ï¼Œä¸ºç©ºæ•°ç»„
  @Watch('onLoginStateChange')
  @StorageLink('isLoggedIn') isLoggedIn: boolean = false;
  @StorageLink('currentUserInfo') currentUserInfo: UserInfo | null = null;
  // å­˜å‚¨ä¼šè¯æ ‡é¢˜ï¼ˆç”¨äºé¡µé¢æ˜¾ç¤ºï¼‰
  @State sessionTitle: string = 'æ–°å»ºå¯¹è¯';

  aboutToAppear() {
    // 1. è·å–è·³è½¬æºå¸¦çš„sessionId
    const stack = RouterModule.getStack();
    const param = stack.getParamByIndex(stack.size() - 1) as Record<string, number>;

    if (param && param['sessionId']) {
      this.sessionId = param['sessionId'];
      console.log('ğŸ”¢ChatPageè·å–åˆ°sessionId:', this.sessionId);
    } else {
      console.error('ChatPageæœªè·å–åˆ°sessionId');
      promptAction.showToast({ message: 'ä¼šè¯IDå¼‚å¸¸' });
      RouterModule.push(RouterMap.AI_PAGE); // å¼‚å¸¸æ—¶è¿”å›AIåˆ—è¡¨é¡µ
    }
  }

  // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
  private onLoginStateChange() {
    console.log('ChatPageç™»å½•çŠ¶æ€å˜åŒ–:', this.isLoggedIn);
    if (!this.isLoggedIn) {
      RouterModule.push(RouterMap.AI_PAGE); // é€€å‡ºç™»å½•è¿”å›åˆ—è¡¨é¡µ
    }
  }

  // é€šçŸ¥AiPageåˆ·æ–°åˆ—è¡¨
  private notifyAiPageRefresh() {
    try {
      postCardAction(this, {
        action: 'refreshSessionList',
        params: {}
      });
    } catch (error) {
      console.error('é€šçŸ¥åˆ·æ–°å¤±è´¥:', error);
    }
  }

  build() {
    NavDestination() {
      Column() {
        // é¡µé¢Headerï¼ˆç®€åŒ–ç‰ˆï¼Œå¯å‚è€ƒSessionDetailPageï¼‰
        this.buildHeader()

        // å¤ç”¨æµå¼é—®ç­”ç»„ä»¶ï¼ˆæ–°å»ºä¼šè¯æ— å†å²æ¶ˆæ¯ï¼ŒinitialMessagesä¸ºç©ºï¼‰
        StreamChatComponent({
          sessionId: this.sessionId,
          initialMessages: this.initialMessages,
          userId: this.currentUserInfo?.id || 0,
          isLoggedIn: this.isLoggedIn
        })
          .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F9FAFB')
    }
  }

  @Builder
  buildHeader() {
    Row() {
      // è¿”å›æŒ‰é’®
      Button({ type: ButtonType.Circle, stateEffect: true })
        .width(32)
        .height(32)
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .onClick(() => {
          RouterModule.push(RouterMap.AI_PAGE); // è¿”å›AIåˆ—è¡¨é¡µ
          this.notifyAiPageRefresh(); // è¿”å›æ—¶å¼ºåˆ¶åˆ·æ–°AiPageåˆ—è¡¨
        })

      Text(this.sessionTitle)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#1F2329')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // å ä½ç¬¦ï¼ˆä¿æŒå¸ƒå±€å¯¹ç§°ï¼‰
      Column().width(32).height(32)
    }
    .padding({
      left: 16,
      right: 16,
      top: 12,
      bottom: 12
    })
    .backgroundColor('#FFFFFF')
    .borderColor('#E5E6EB')
    .borderWidth({ bottom: 1 })
  }
}